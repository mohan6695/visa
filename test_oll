#!/usr/bin/env python3
"""
Test script for Ollama Qwen integration with KiloCode
"""

import asyncio
import httpx

OLLAMA_BASE_URL = "http://localhost:11434"
DEFAULT_MODEL = "qwen2.5:3b"


async def test_ollama_connection():
    """Test if Ollama is running and Qwen model is available."""
    print("=" * 50)
    print("Testing Ollama Qwen Integration")
    print("=" * 50)
    
    async with httpx.AsyncClient() as client:
        # Test 1: List available models
        print("\n1. Listing available models...")
        try:
            response = await client.get(f"{OLLAMA_BASE_URL}/api/tags", timeout=10.0)
            models = response.json().get("models", [])
            print(f"   Available models: {[m['name'] for m in models]}")
        except Exception as e:
            print(f"   Error listing models: {e}")
            return False
    
    return True


async def test_completion(prompt: str = "Explain visa requirements in simple terms"):
    """Test text completion with Qwen."""
    print(f"\n2. Testing completion...")
    print(f"   Prompt: {prompt}")
    
    async with httpx.AsyncClient() as client:
        payload = {
            "model": DEFAULT_MODEL,
            "prompt": prompt,
            "stream": False,
            "options": {"temperature": 0.7, "num_predict": 256},
        }
        
        try:
            response = await client.post(
                f"{OLLAMA_BASE_URL}/api/generate",
                json=payload,
                timeout=60.0,
            )
            result = response.json()
            print(f"   Response: {result.get('response', '')[:200]}...")
            return True
        except Exception as e:
            print(f"   Error: {e}")
            return False


async def test_chat():
    """Test chat completion with conversation history."""
    print("\n3. Testing chat completion...")
    
    messages = [
        {"role": "system", "content": "You are a helpful visa and immigration assistant."},
        {"role": "user", "content": "What is an H-1B visa?"},
    ]
    
    async with httpx.AsyncClient() as client:
        payload = {
            "model": DEFAULT_MODEL,
            "messages": messages,
            "stream": False,
        }
        
        try:
            response = await client.post(
                f"{OLLAMA_BASE_URL}/api/chat",
                json=payload,
                timeout=60.0,
            )
            result = response.json()
            print(f"   Response: {result.get('message', {}).get('content', '')[:200]}...")
            return True
        except Exception as e:
            print(f"   Error: {e}")
            return False


async def test_embeddings():
    """Test embedding generation."""
    print("\n4. Testing embeddings...")
    
    text = "H-1B visa application process"
    
    async with httpx.AsyncClient() as client:
        payload = {
            "model": DEFAULT_MODEL,
            "input": text,
        }
        
        try:
            response = await client.post(
                f"{OLLAMA_BASE_URL}/api/embeddings",
                json=payload,
                timeout=30.0,
            )
            result = response.json()
            embedding = result.get("embedding", [])
            print(f"   Embedding dimensions: {len(embedding)}")
            return True
        except Exception as e:
            print(f"   Error: {e}")
            return False


async def main():
    """Run all tests."""
    all_passed = True
    
    # Test connection
    if not await test_ollama_connection():
        print("\n❌ Ollama is not running. Please start Ollama first:")
        print("   brew services start ollama  # or ollama serve")
        return
    
    # Run tests
    all_passed &= await test_completion()
    all_passed &= await test_chat()
    all_passed &= await test_embeddings()
    
    print("\n" + "=" * 50)
    if all_passed:
        print("✅ All tests passed! Ollama Qwen is ready for KiloCode.")
        print("\nTo use in KiloCode, start the MCP server:")
        print("   python ollama_mcp_server.py")
    else:
        print("❌ Some tests failed. Check the errors above.")
    print("=" * 50)


if __name__ == "__main__":
    asyncio.run(main())
