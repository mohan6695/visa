---
import AdBanner from './ads/AdBanner.astro';
import AdSidebar from './ads/AdSidebar.astro';

interface Post {
  id: string;
  title: string;
  content: string;
  author_id: string | null;
  group_id: string | null;
  score: number;
  view_count: number;
  is_answered: boolean;
  created_at: string;
  rrf_score?: number;
  source?: string;
}

const USA_GROUP_ID = "550e8400-e29b-41d4-a716-446655440001";
---

<div class="max-w-7xl mx-auto px-4 py-8">
  <AdSidebar slotId="left-sidebar-usa" position="left" />
  <AdSidebar slotId="right-sidebar-usa" position="right" />
  <AdBanner slotId="top-banner-usa" format="horizontal" className="w-full mb-8" />

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <div class="lg:col-span-3">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900">USA Visa Posts</h2>
        <div class="text-sm text-gray-600">
          <span id="postCount">Loading...</span>
        </div>
      </div>
      
      <form class="flex gap-2 mb-6" id="searchForm">
        <input
          type="text"
          placeholder="Search posts... (H1B, OPT, visa stamping...)"
          name="searchQuery"
          id="searchQuery"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        />
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
          Search
        </button>
      </form>
      
      <div class="space-y-6" id="postsContainer">
        <div class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-2 text-gray-600">Loading posts...</p>
        </div>
      </div>
    </div>
    
    <div class="lg:col-span-1">
      <div class="bg-white rounded-xl shadow-lg p-6 sticky top-4">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Filters</h3>
        <div id="latency" class="mb-4"></div>
        <div class="space-y-2">
          <button onclick="fetchPosts('')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">ðŸ“Š All Posts</button>
          <button onclick="fetchPosts('H1B')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">ðŸ”¤ H1B Visa</button>
          <button onclick="fetchPosts('OPT')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">ðŸŽ“ OPT</button>
          <button onclick="fetchPosts('green card')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">ðŸŸ¢ Green Card</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let posts = [];
  let latency = null;
  const USA_GROUP_ID = "550e8400-e29b-41d4-a716-446655440001";

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    return `${Math.floor(diffInSeconds / 86400)}d ago`;
  };

  const fetchPosts = async (query = '') => {
    const postsContainer = document.getElementById('postsContainer');
    const postCount = document.getElementById('postCount');
    
    postsContainer.innerHTML = `
      <div class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-600">Loading posts...</p>
      </div>
    `;
    postCount.textContent = 'Loading...';

    try {
      const startTime = performance.now();
      const response = await fetch(`/api/v1/sidebar/search?q=${encodeURIComponent(query)}&group_id=${USA_GROUP_ID}&limit=12`);
      const data = await response.json();
      const endTime = performance.now();
      latency = endTime - startTime;
      
      posts = data.posts || [];
      
      if (latency) {
        document.getElementById('latency').innerHTML = `<div class="p-3 bg-green-50 rounded-lg"><p class="text-sm text-green-800">âš¡ ${latency.toFixed(0)}ms</p></div>`;
      }
      
      postCount.textContent = `${posts.length} posts ${latency ? `<span class="text-green-600 ml-2">(${latency.toFixed(0)}ms)</span>` : ''}`;
      
      if (posts.length === 0) {
        postsContainer.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <p>No posts found. Try a different search.</p>
          </div>
        `;
      } else {
        postsContainer.innerHTML = `
          ${posts.slice(0, 3).map((post, index) => `
            <div class="bg-gradient-to-r from-blue-50 to-white rounded-lg border border-blue-200 p-6">
              <div class="flex items-start space-x-4">
                <div class="flex flex-col items-center">
                  <button class="text-blue-600 hover:text-green-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7"></path></svg></button>
                  <span class="text-lg font-semibold text-blue-700">${post.score}</span>
                  <button class="text-blue-600 hover:text-red-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></button>
                </div>
                <div class="flex-1">
                  <span class="inline-block bg-blue-600 text-white text-xs px-2 py-1 rounded mb-2">Answer ${index + 1}</span>
                  <h3 class="font-semibold text-gray-900 text-lg">${post.title || 'No title'}</h3>
                  <p class="text-sm text-gray-600 mb-3">${formatDate(post.created_at)} â€¢ ${post.source}</p>
                  <p class="text-gray-700 mb-3">${post.content?.slice(0, 500)}${post.content?.length > 500 ? '...' : ''}</p>
                  <button onclick="showPostDetails('${post.id}')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Read more â†’</button>
                </div>
              </div>
            </div>
          `).join('')}
          
          <div class="mt-8">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Related Posts</h3>
            <div class="grid gap-4">
              ${posts.slice(3).map((post) => `
                <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md cursor-pointer" onclick="showPostDetails('${post.id}')">
                  <div class="flex items-start space-x-4">
                    <div class="flex flex-col items-center">
                      <span class="text-sm font-semibold text-gray-700">${post.score}</span>
                      <span class="text-xs text-gray-500">votes</span>
                    </div>
                    <div class="flex-1">
                      <h4 class="font-medium text-gray-900 mb-1">${post.title || 'No title'}</h4>
                      <p class="text-sm text-gray-600 line-clamp-2">${post.content?.slice(0, 150)}...</p>
                      <p class="text-xs text-gray-500 mt-1">${formatDate(post.created_at)} â€¢ ${post.view_count} views</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error fetching posts:', error);
      postsContainer.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>Error loading posts. Please try again later.</p>
        </div>
      `;
      postCount.textContent = 'Error';
    }
  };

  const showPostDetails = (postId) => {
    const post = posts.find(p => p.id === postId);
    if (post) {
      window.location.href = `/post/${postId}`;
    }
  };

  document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const searchQuery = document.getElementById('searchQuery').value;
    fetchPosts(searchQuery);
  });

  window.fetchPosts = fetchPosts;
  window.showPostDetails = showPostDetails;

  // Fetch initial posts when page loads
  fetchPosts();
</script>
