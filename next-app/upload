#!/usr/bin/env python3
"""
Supabase Storage Upload - Create bucket and upload file
Usage: 
    export SUPABASE_SERVICE_KEY="your-service-role-key"
    python3 upload_with_service_key.py
"""

import os
import requests

def list_buckets(supabase_url, service_key):
    """List all buckets"""
    url = f"{supabase_url}/storage/v1/bucket"
    headers = {'Authorization': f'Bearer {service_key}'}
    return requests.get(url, headers=headers)

def create_bucket(supabase_url, service_key, bucket_name):
    """Create a new bucket"""
    url = f"{supabase_url}/storage/v1/bucket"
    headers = {
        'Authorization': f'Bearer {service_key}',
        'Content-Type': 'application/json'
    }
    data = {'id': bucket_name, 'name': bucket_name, 'public': True}
    return requests.post(url, headers=headers, json=data)

def upload_presigned(supabase_url, service_key, bucket_name, file_path, object_name):
    """Upload using presigned URL"""
    # Get signed URL
    sign_url = f"{supabase_url}/storage/v1/object/upload/sign/{bucket_name}/{object_name}"
    headers = {
        'Authorization': f'Bearer {service_key}',
        'Content-Type': 'application/json'
    }
    sign_resp = requests.post(sign_url, headers=headers, json={})
    
    if sign_resp.status_code != 200:
        return sign_resp
    
    signed_url = sign_resp.json().get('signed_url')
    
    # Upload file
    with open(file_path, 'rb') as f:
        file_content = f.read()
    
    upload_resp = requests.put(signed_url, data=file_content)
    return upload_resp

def main():
    supabase_url = 'https://cycnichledvqbxevrwnt.storage.supabase.co'
    service_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5Y25pY2hsZWR2cWJ4ZXZyd250Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjAzMzU5NiwiZXhwIjoyMDgxNjA5NTk2fQ.Sdc2cOACcemGPdn4pCp-7LlbmvT3yfOwnLliJr-ZJd0'
    
    if not service_key:
        print("Error: Set SUPABASE_SERVICE_KEY environment variable")
        print("Example: export SUPABASE_SERVICE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'")
        return
    
    bucket_name = 'posts'
    file_path = '/Users/mohanakrishnanarsupalli/Downloads/new_posts.json'
    object_name = 'new_posts.json'
    
    print("=" * 50)
    print("Supabase Storage Upload with Service Key")
    print("=" * 50)
    
    # List buckets
    print("\n1. Listing buckets...")
    resp = list_buckets(supabase_url, service_key)
    print(f"   Status: {resp.status_code}")
    buckets = resp.json() if resp.status_code == 200 else []
    
    bucket_exists = any(b.get('name') == bucket_name or b.get('id') == bucket_name for b in buckets)
    print(f"   Buckets: {[b.get('name') for b in buckets]}")
    print(f"   '{bucket_name}' exists: {bucket_exists}")
    
    # Create bucket if needed
    if not bucket_exists:
        print("\n2. Creating bucket...")
        resp = create_bucket(supabase_url, service_key, bucket_name)
        print(f"   Status: {resp.status_code}")
        if resp.status_code in [200, 201]:
            print("   ✓ Bucket created!")
        else:
            print(f"   ✗ Failed: {resp.text[:200]}")
            return
    
    # Upload file
    print("\n3. Uploading file...")
    resp = upload_presigned(supabase_url, service_key, bucket_name, file_path, object_name)
    print(f"   Status: {resp.status_code}")
    
    if resp.status_code in [200, 201]:
        print("   ✓ File uploaded!")
        print(f"   URL: {supabase_url}/storage/v1/object/public/{bucket_name}/{object_name}")
    else:
        print(f"   ✗ Failed: {resp.text[:200]}")
    
    print("\n" + "=" * 50)

if __name__ == '__main__':
    main()
